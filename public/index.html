<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Based News | Blake Rayvid</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="container header-bar">
      <div class="title-group">
        <h1>Based News Reader</h1>
        <p class="subheading">Curated with Gemini, updated hourly.</p>
      </div>
      <div class="header-right-placeholder"></div>
    </div>
  </header>

  <main class="container">
    <section id="digest-container">
      <div class="digest-pagination">
        <button id="older-btn" class="arrow-btn" disabled title="Older Digest">◄</button>
        <div id="dots-container"></div>
        <button id="newer-btn" class="arrow-btn" disabled title="Newer Digest">►</button>
      </div>
       <h3 id="digest-timestamp-header" class="digest-timestamp">Loading...</h3>
      <div id="digest-slider-wrapper">
        <div id="digest-slider">
          <!-- Slides will be injected here by JS in reverse chronological order -->
        </div>
      </div>
    </section>

    <section id="world-summary">
    <!-- summary.html will be injected here -->
  </section>
  </main>

  <footer>
    <div class="container">
      <p><a href="https://docs.google.com/spreadsheets/d/1OjpsQEnrNwcXEWYuPskGRA5Jf-U8e_x0x3j2CKJualg/edit?usp=sharing">Settings</a> | <a href="https://github.com/brayvid/based-news">GitHub</a> | <a href="https://blakerayvid.com">Portfolio</a></p>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const digestSliderWrapper = document.getElementById("digest-slider-wrapper");
      const digestSlider = document.getElementById("digest-slider");
      const olderBtn = document.getElementById("older-btn");
      const newerBtn = document.getElementById("newer-btn");
      const dotsContainer = document.getElementById("dots-container");
      const timestampHeader = document.getElementById("digest-timestamp-header");
      const summarySection = document.getElementById("world-summary");

      let manifest = [];
      // currentIndex is the LOGICAL index: 0 is always Latest, 1 is newest historical, etc.
      let currentIndex = 0; 
      let totalItems = 0;
      let touchStartX = 0;
      let touchEndX = 0;
      const swipeThreshold = 50; 

      function updateNavControls() {
        // Disable buttons at the ends of the carousel
        olderBtn.disabled = currentIndex >= totalItems - 1; // At the oldest
        newerBtn.disabled = currentIndex <= 0;             // At the newest
        
        // Update the active state of the dots
        const dots = document.querySelectorAll('.dot');
        dots.forEach((dot) => {
          const dotIndex = parseInt(dot.dataset.logicalIndex);
          dot.classList.toggle('active', dotIndex === currentIndex);
        });
      }

      function updateTimestampHeader() {
        if (currentIndex === 0) {
            timestampHeader.textContent = "Latest Headlines";
        } else {
            // manifest is 0-indexed and doesn't include "Latest", so offset by -1
            const entry = manifest[currentIndex - 1];
            if (entry) {
                const date = new Date(entry.timestamp);
                const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' };
                timestampHeader.textContent = date.toLocaleDateString(undefined, options);
            }
        }
      }
      
      function adjustWrapperHeight(slide) {
        if (slide) {
          requestAnimationFrame(() => {
            digestSliderWrapper.style.height = `${slide.offsetHeight}px`;
          });
        }
      }

      function showDigest(index) {
          if (index < 0 || index >= totalItems) return;
          
          currentIndex = index; // Set the current logical index
          const slideId = `digest-slide-${index}`;
          const slide = document.getElementById(slideId);

          if (!slide) {
              console.error(`Slide container for index ${index} not found!`);
              return;
          }

          // Lazy-load historical content if it hasn't been loaded yet
          if (slide.children.length === 0 && index > 0) {
              loadDigestContent(index, slide);
          }
          
          // Convert the logical index to the visual index for the CSS transform
          // Visual index 0 = oldest slide (leftmost), N = newest slide (rightmost)
          const visualIndex = (totalItems - 1) - currentIndex;
          digestSlider.style.transform = `translateX(-${visualIndex * 100}%)`;
          
          updateNavControls();
          updateTimestampHeader();
      }

      async function loadDigestContent(index, slideElement) {
        const entry = manifest[index - 1]; // manifest is offset
        if (!entry || !entry.file) return;

        try {
            const response = await fetch(entry.file);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const html = await response.text();
            slideElement.innerHTML = html;
            // Adjust height after content is loaded if it's the current slide
            if (index === currentIndex) {
                adjustWrapperHeight(slideElement);
            }
        } catch (error) {
            slideElement.innerHTML = "<p>Unable to load this digest.</p>";
            console.error(`Could not load content for index ${index}:`, error);
        }
      }
      
      function handleSwipe() {
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > swipeThreshold) {
            if (deltaX < 0) { // Swipe Left: Go Newer (move to a slide on the right)
                if (currentIndex > 0) showDigest(currentIndex - 1);
            } else { // Swipe Right: Go Older (move to a slide on the left)
                if (currentIndex < totalItems - 1) showDigest(currentIndex + 1);
            }
        }
      }

      // --- EVENT LISTENERS ---
      digestSlider.addEventListener('transitionend', () => {
          adjustWrapperHeight(document.getElementById(`digest-slide-${currentIndex}`));
      });
      digestSliderWrapper.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
      digestSliderWrapper.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
      window.addEventListener('resize', () => adjustWrapperHeight(document.getElementById(`digest-slide-${currentIndex}`)));

      // --- INITIALIZATION ---
      async function initializeSite() {
          try {
              const manifestRes = await fetch("digest-manifest.json");
              if (!manifestRes.ok) throw new Error("Manifest not found");
              
              manifest = await manifestRes.json(); // Newest historical is at index 0
              totalItems = manifest.length + 1; // +1 for the "Latest" digest
              
              digestSlider.innerHTML = '';
              dotsContainer.innerHTML = '';

              // Create slides and dots in visual order: Oldest (left) to Newest (right)
              for (let visualIndex = 0; visualIndex < totalItems; visualIndex++) {
                  const logicalIndex = (totalItems - 1) - visualIndex;

                  // 1. Create the slide container, identified by its logical index
                  const slide = document.createElement('div');
                  slide.className = 'digest-slide';
                  slide.id = `digest-slide-${logicalIndex}`;
                  digestSlider.appendChild(slide);

                  // 2. Create the corresponding navigation dot
                  const dot = document.createElement('div');
                  dot.className = 'dot';
                  dot.dataset.logicalIndex = logicalIndex;
                  dot.onclick = () => showDigest(logicalIndex);
                  
                  if (logicalIndex === 0) {
                      dot.title = "Latest Headlines";
                  } else {
                      const entry = manifest[logicalIndex - 1];
                      const date = new Date(entry.timestamp);
                      dot.title = `Digest from ${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}`;
                  }
                  dotsContainer.appendChild(dot); 
              }
              
              // Pre-load the content for the "Latest" digest slide
              const latestSlideElement = document.getElementById('digest-slide-0');
              const digestRes = await fetch("digest.html").catch(e => e);
              if (digestRes instanceof Response && digestRes.ok) {
                  latestSlideElement.innerHTML = await digestRes.text();
              } else {
                  latestSlideElement.innerHTML = "<p>Could not load latest headlines.</p>";
              }
              
              // 'Older' (◄) means increasing the logical index (e.g., from 0 to 1)
              olderBtn.onclick = () => { if (currentIndex < totalItems - 1) showDigest(currentIndex + 1); };
              // 'Newer' (►) means decreasing the logical index (e.g., from 1 to 0)
              newerBtn.onclick = () => { if (currentIndex > 0) showDigest(currentIndex - 1); };
              
              // Start by showing the latest digest (logical index 0), which is the rightmost slide
              showDigest(0);

          } catch (error) {
              console.error("Initialization failed:", error);
              timestampHeader.textContent = "Could not load headlines";
          }

          fetch("summary.html")
            .then(res => res.text())
            .then(html => {
              const summaryDoc = new DOMParser().parseFromString(html, "text/html");
              summarySection.innerHTML = `<h2 class="summary-heading">Week in Review</h2>${summaryDoc.body.innerHTML}`;
              const lastUpdated = summaryDoc.getElementById("summary-last-updated");
              if (lastUpdated) {
                const stamp = document.createElement("p");
                stamp.className = "timestamp";
                stamp.style.fontSize = "0.9em";
                stamp.style.color = "#666";
                stamp.style.marginTop = "0.5em";
                stamp.textContent = lastUpdated.textContent;
                stamp.style.textAlign = "center";
                document.getElementById("world-summary").appendChild(stamp);
              }
            })
            .catch(() => {
              summarySection.innerHTML = "<p>Unable to load summary.</p>";
            });
      }
      
      initializeSite();
    });
  </script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8LC9EF8GSD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8LC9EF8GSD');
  </script>
</body>
</html>