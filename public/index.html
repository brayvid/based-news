<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Based News | Blake Rayvid</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
</head>
<body>
  <header>
    <div class="container header-bar">
      <div class="title-group">
        <h1>Based News Reader</h1>
        <p class="subheading">Curated with Gemini, updated hourly.</p>
      </div>
      <div class="header-right-placeholder"></div>
    </div>
  </header>

  <main class="container">
    <section id="digest-container">
      <div class="digest-pagination">
        <button id="older-btn" class="arrow-btn" disabled title="Older Digest">◄</button>
        <div id="dots-container"></div>
        <button id="newer-btn" class="arrow-btn" disabled title="Newer Digest">►</button>
      </div>
       <h3 id="digest-timestamp-header" class="digest-timestamp">Loading...</h3>
      <div id="digest-slider-wrapper">
        <div id="digest-slider">
          <!-- Slides will be injected here by JS in reverse chronological order -->
        </div>
      </div>
    </section>

    <section id="world-summary">
    <!-- summary.html will be injected here -->
  </section>
  </main>

  <footer>
    <div class="container">
      <p><a href="https://docs.google.com/spreadsheets/d/1OjpsQEnrNwcXEWYuPskGRA5Jf-U8e_x0x3j2CKJualg/edit?usp=sharing">Settings</a> | <a href="https://github.com/brayvid/based-news">GitHub</a> | <a href="https://blakerayvid.com">Portfolio</a></p>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const digestSliderWrapper = document.getElementById("digest-slider-wrapper");
      const digestSlider = document.getElementById("digest-slider");
      const olderBtn = document.getElementById("older-btn");
      const newerBtn = document.getElementById("newer-btn");
      const dotsContainer = document.getElementById("dots-container");
      const timestampHeader = document.getElementById("digest-timestamp-header");
      const summarySection = document.getElementById("world-summary");

      let manifest = [];
      // currentIndex is the LOGICAL index: 0 is newest, 1 is next newest, etc.
      let currentIndex = 0; 
      let totalItems = 0;
      let touchStartX = 0;
      let touchEndX = 0;
      const swipeThreshold = 50; 

      function updateNavControls() {
        olderBtn.disabled = currentIndex >= totalItems - 1; // At the oldest
        newerBtn.disabled = currentIndex <= 0;             // At the newest
        
        const dots = document.querySelectorAll('.dot');
        dots.forEach((dot) => {
          const dotIndex = parseInt(dot.dataset.logicalIndex);
          dot.classList.toggle('active', dotIndex === currentIndex);
        });
      }

      function updateTimestampHeader() {
        const entry = manifest[currentIndex];
        if (!entry) return;

        if (currentIndex === 0) {
            timestampHeader.textContent = "Latest Headlines";
        } else {
            const date = new Date(entry.timestamp);
            const options = { weekday: 'long', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' };
            timestampHeader.textContent = date.toLocaleDateString(undefined, options);
        }
      }
      
      function adjustWrapperHeight(slide) {
        if (slide) {
          requestAnimationFrame(() => {
            digestSliderWrapper.style.height = `${slide.offsetHeight}px`;
          });
        }
      }

      async function showDigest(index) {
          if (index < 0 || index >= totalItems) return;
          
          currentIndex = index;
          const slideId = `digest-slide-${index}`;
          const slide = document.getElementById(slideId);

          if (!slide) {
              console.error(`Slide container for index ${index} not found!`);
              return;
          }

          // Lazy-load content if the slide is empty
          if (slide.children.length === 0) {
              await loadDigestContent(index, slide);
          }
          
          // Convert logical index to visual index for CSS transform
          const visualIndex = (totalItems - 1) - currentIndex;
          digestSlider.style.transform = `translateX(-${visualIndex * 100}%)`;
          
          updateNavControls();
          updateTimestampHeader();
      }

      async function loadDigestContent(index, slideElement) {
        // CORRECTED: Direct mapping from index to manifest entry
        const entry = manifest[index]; 
        if (!entry || !entry.file) return;

        try {
            const response = await fetch(entry.file);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const html = await response.text();
            slideElement.innerHTML = html;
            if (index === currentIndex) {
                adjustWrapperHeight(slideElement);
            }
        } catch (error) {
            slideElement.innerHTML = "<p>Unable to load this digest.</p>";
            console.error(`Could not load content for index ${index}:`, error);
        }
      }
      
      function handleSwipe() {
        const deltaX = touchEndX - touchStartX;
        if (Math.abs(deltaX) > swipeThreshold) {
            if (deltaX < 0) { // Swipe Left: Go Newer
                if (currentIndex > 0) showDigest(currentIndex - 1);
            } else { // Swipe Right: Go Older
                if (currentIndex < totalItems - 1) showDigest(currentIndex + 1);
            }
        }
      }

      // --- EVENT LISTENERS ---
      digestSlider.addEventListener('transitionend', () => {
          adjustWrapperHeight(document.getElementById(`digest-slide-${currentIndex}`));
      });
      digestSliderWrapper.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
      digestSliderWrapper.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
      window.addEventListener('resize', () => adjustWrapperHeight(document.getElementById(`digest-slide-${currentIndex}`)));

      // --- INITIALIZATION ---
      async function initializeSite() {
          try {
              const manifestRes = await fetch("digest-manifest.json");
              if (!manifestRes.ok) throw new Error("Manifest not found");
              
              manifest = await manifestRes.json();
              // CORRECTED: Total items is now the exact length of the manifest
              totalItems = manifest.length; 
              
              if(totalItems === 0) {
                throw new Error("Manifest is empty. No digests to show.");
              }

              digestSlider.innerHTML = '';
              dotsContainer.innerHTML = '';

              // Create slides and dots in visual order: Oldest (left) to Newest (right)
              for (let visualIndex = 0; visualIndex < totalItems; visualIndex++) {
                  const logicalIndex = (totalItems - 1) - visualIndex;

                  const slide = document.createElement('div');
                  slide.className = 'digest-slide';
                  slide.id = `digest-slide-${logicalIndex}`;
                  digestSlider.appendChild(slide);

                  const dot = document.createElement('div');
                  dot.className = 'dot';
                  dot.dataset.logicalIndex = logicalIndex;
                  dot.onclick = () => showDigest(logicalIndex);
                  
                  // CORRECTED: Get title info directly from manifest
                  const entry = manifest[logicalIndex];
                  const date = new Date(entry.timestamp);
                  dot.title = `Digest from ${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}`;
                  dotsContainer.appendChild(dot); 
              }
              
              olderBtn.onclick = () => { if (currentIndex < totalItems - 1) showDigest(currentIndex + 1); };
              newerBtn.onclick = () => { if (currentIndex > 0) showDigest(currentIndex - 1); };
              
              // Start by showing the latest digest (logical index 0).
              // The showDigest function will automatically trigger content loading.
              await showDigest(0);

          } catch (error) {
              console.error("Initialization failed:", error);
              timestampHeader.textContent = "Could not load headlines";
          }

          fetch("summary.html")
            .then(res => res.text())
            .then(html => {
              const summaryDoc = new DOMParser().parseFromString(html, "text/html");
              summarySection.innerHTML = `<h2 class="summary-heading">Week in Review</h2>${summaryDoc.body.innerHTML}`;
              const lastUpdated = summaryDoc.getElementById("summary-last-updated");
              if (lastUpdated) {
                const stamp = document.createElement("p");
                stamp.className = "timestamp";
                stamp.style.fontSize = "0.9em";
                stamp.style.color = "#666";
                stamp.style.marginTop = "0.5em";
                stamp.textContent = lastUpdated.textContent;
                stamp.style.textAlign = "center";
                document.getElementById("world-summary").appendChild(stamp);
              }
            })
            .catch(() => {
              summarySection.innerHTML = "<p>Unable to load summary.</p>";
            });
      }
      
      initializeSite();
    });
  </script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8LC9EF8GSD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8LC9EF8GSD');
  </script>
</body>
</html>