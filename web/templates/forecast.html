<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Forecast | Based News</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" sizes="any">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: 'Open Sans', sans-serif; background-color: #121212; color: #e0e0e0; line-height: 1.6; }
    .container { width: 90%; max-width: 800px; margin: 0 auto; padding-top: 4px; }
    header { background-color: #121212; padding: 1.5em 0; text-align: center; }
    header h1 { margin: 0; font-family: 'Merriweather', serif; font-size: clamp(1.8em, 8vw, 2.5em); color: #e0e0e0; cursor: pointer; }
    header h1:hover { text-decoration: underline; }
    header h1 a { color: inherit; text-decoration: none; }
    .subheading { margin-top: 0.5em; font-size: 1.1em; color: #bbb; }
    main { padding-top: 1em; }
    .prediction-card {
        background: #1e1e1e;
        border: 1px solid #333;
        margin-bottom: 2em;
        padding: 1.5em;
    }
    .card-header {
        border-bottom: 1px solid #444;
        padding-bottom: 0.8em;
        margin-bottom: 1em;
    }
    .card-header h2 {
        font-family: 'Merriweather', serif;
        margin: 0;
        font-size: 1.4em;
    }
    .prediction-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5em;
        flex-wrap: wrap;
    }
    .prediction-signal {
        font-size: 1.5em;
        font-weight: bold;
    }
    .prediction-up { color: #4CAF50; } /* Green */
    .prediction-down { color: #F44336; } /* Red */
    .confidence {
        font-size: 1.2em;
        color: #ccc;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 1.5em;
    }
    footer { text-align: center; font-size: 0.9em; color: #999; padding: 2em 0; }
    footer a { color: #8ab4f8; }

    @media (max-width: 600px) {
        .card-header h2 { font-size: 1.2em; }
        .prediction-details { flex-direction: column; align-items: flex-start; gap: 0.25em; }
        .prediction-signal { font-size: 1.2em; }
        .confidence { font-size: 1.0em; }
    }
  </style>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap" media="print" onload="this.media='all'" />
</head>
<body>
  <header>
    <div class="container">
      <h1><a href="{{ url_for('index') }}">Based News Reader</a></h1>
      <p class="subheading">Market Forecast (S&P 500)</p>
    </div>
  </header>

  <main class="container">
    {% if predictions %}
        {% set latest_prediction = predictions[0] %}
        
        <div class="prediction-card">
            <div class="card-header">
                <h2>{{ latest_prediction.news_date_formatted }}</h2>
                <div class="prediction-details">
                    {% if latest_prediction.direction == 'UP' %}
                        <span class="prediction-signal prediction-up">1-WEEK FORECAST: HIGHER ↑</span>
                    {% else %}
                        <span class="prediction-signal prediction-down">1-WEEK FORECAST: LOWER ↓</span>
                    {% endif %}
                    <span class="confidence">Confidence: {{ "%.1f"|format(latest_prediction.confidence * 100) }}%</span>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="forecast-chart"></canvas>
            </div>
        </div>
    {% else %}
        <p>No forecasts found. Forecasts are generated on weekdays shortly before the market opens.</p>
    {% endif %}
  </main>

  <footer>
    <div class="container">
      <p><a href="/">Home</a> | <a href="https://docs.google.com/spreadsheets/d/1OjpsQEnrNwcXEWYuPskGRA5Jf-U8e_x0x3j2CKJualg/edit?usp=sharing">Settings</a> | <a href="https://github.com/brayvid/based-news">GitHub</a> | <a href="https://blakerayvid.com">Portfolio</a></p>
    </div>
  </footer>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const jsonString = '{{ predictions | tojson | safe }}';
        const predictionsData = JSON.parse(jsonString);

        // --- THE FIX: Check for data inside JavaScript ---
        if (predictionsData && predictionsData.length > 0) {
            const prediction = predictionsData[0]; // Get the latest prediction

            // --- Business Day Helper Function ---
            function addBusinessDays(utcTimestamp, days) {
                let currentDate = new Date(utcTimestamp);
                let added = 0;
                while (added < days) {
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                    const dayOfWeek = currentDate.getUTCDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { added++; }
                }
                return currentDate;
            }
            
            const ctx = document.getElementById('forecast-chart');
            if (!ctx) return;

            const chartData = prediction.chart_data;
            if (!chartData || !chartData.points || chartData.points.length === 0) {
                const container = ctx.parentElement;
                if (container) container.style.display = 'none';
                return; 
            }

            const timezoneOffsetMs = new Date().getTimezoneOffset() * 60 * 1000;
            const adjustedHistoricalPoints = chartData.points.map(point => ({ x: point.x + timezoneOffsetMs, y: point.y }));

            const lastPoint = adjustedHistoricalPoints[adjustedHistoricalPoints.length - 1];
            const lastTimestamp = lastPoint.x;
            const lastPrice = lastPoint.y;
            
            const forecastPercentage = prediction.direction === 'UP' ? 1.015 : 0.985;
            const forecastTarget = lastPrice * forecastPercentage;

            const forecastLineData = [];
            const numForecastDays = 5;
            forecastLineData.push({ x: lastTimestamp, y: lastPrice });

            const futureDate = addBusinessDays(lastTimestamp, numForecastDays);
            const futureTimestamp = futureDate.getTime();
            forecastLineData.push({ x: futureTimestamp, y: forecastTarget });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'SPY Daily Close', data: adjustedHistoricalPoints, borderColor: 'rgb(75, 192, 192)', borderWidth: 2, pointRadius: 0, tension: 0.1 },
                        { label: '1-Week Forecast', data: forecastLineData, borderColor: prediction.direction === 'UP' ? 'rgba(80, 160, 115, 0.8)' : 'rgba(215, 85, 65, 0.8)', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, tension: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#ccc', source: 'auto', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
                        y: { position: 'right', grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#ccc' } }
                    },
                    plugins: { legend: { display: false }, tooltip: { intersect: false, mode: 'nearest' } }
                }
            });
        }
    });
  </script>
</body>
</html>